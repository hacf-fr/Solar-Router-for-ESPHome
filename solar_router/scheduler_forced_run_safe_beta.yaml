#stop scheduler when temp is above stop_temperature or Safety limit reached is activated 
substitutions:
  scheduler_unique_id: "Forced"
  custom_script: ${scheduler_unique_id}_fake_script

script:
  # A fake empty script to run if user don't provide a custom one
  - id: ${scheduler_unique_id}_fake_script
    then:

  # === SAFETY CHECK SCRIPT ===
  # Disable forced scheduler if temperature or safety limit is reached
  - id: ${scheduler_unique_id}_temperature_guard
    mode: single
    then:
      - lambda: |-
          if (
            id(safety_limit) ||
            (!isnan(id(safety_temperature).state) &&
             id(safety_temperature).state >= id(stop_temperature).state)
          ) {
            ESP_LOGW("forced_scheduler",
              "STOP scheduler: temp=%.1f limit=%d",
              id(safety_temperature).state,
              id(safety_limit)
            );
            id(${scheduler_unique_id}_scheduler_activate).turn_off();
          }

switch:
  # Define if scheduler is active or not
  - platform: template
    name: "Activate ${scheduler_unique_id} Scheduler"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    id: "${scheduler_unique_id}_scheduler_activate"
    on_turn_off:
      then:
        - if:
            condition:
              - switch.is_off: activate
            then:
              # Set router level to 0 then Enable router
              - number.set:
                  id: router_level
                  value: 0
              - switch.turn_on: activate

number:
  # Scheduler Router level from 0 to 100
  - platform: template
    name: "${scheduler_unique_id} Scheduler Router Level"
    id: "${scheduler_unique_id}_scheduler_router_level"
    min_value: 0
    max_value: 100
    initial_value: 100
    step: 1
    unit_of_measurement: "%"
    optimistic: true
    mode: slider

  - platform: template
    name: "${scheduler_unique_id} Scheduler Checking End Threshold"
    id: "${scheduler_unique_id}_scheduler_checking_end_threshold"
    optimistic: true
    min_value: 0
    max_value: 720
    step: 5
    mode: box
    initial_value: 5

  - platform: template
    name: "${scheduler_unique_id} Scheduler Begin Minute"
    id: "${scheduler_unique_id}_scheduler_begin_min"
    optimistic: true
    min_value: 0
    max_value: 55
    step: 5
    mode: box
    initial_value: 0

  - platform: template
    name: "${scheduler_unique_id} Scheduler End Minute"
    id: "${scheduler_unique_id}_scheduler_end_min"
    optimistic: true
    min_value: 0
    max_value: 55
    step: 5
    mode: box
    initial_value: 0

  - platform: template
    name: "${scheduler_unique_id} Scheduler Begin Hour"
    id: "${scheduler_unique_id}_scheduler_begin_hour"
    optimistic: true
    min_value: 0
    max_value: 23
    step: 1
    mode: box
    initial_value: 22

  - platform: template
    name: "${scheduler_unique_id} Scheduler End Hour"
    id: "${scheduler_unique_id}_scheduler_end_hour"
    optimistic: true
    min_value: 0
    max_value: 23
    step: 1
    mode: box
    initial_value: 6

time:
  - platform: sntp
    id: ${scheduler_unique_id}_sntp
    on_time:

      # === Every 1 minute: temperature safety check ===
      - seconds: 0
        minutes: /1
        then:
          - script.execute: ${scheduler_unique_id}_temperature_guard

      # === Existing scheduler logic (unchanged) ===
      - seconds: 0
        minutes: /5
        then:
          - if:
              condition:
                - switch.is_on: ${scheduler_unique_id}_scheduler_activate
              then:
                - if:
                    condition:
                      lambda: |-
                        int beginTotalMinutes =
                          id(${scheduler_unique_id}_scheduler_begin_hour).state * 60 +
                          id(${scheduler_unique_id}_scheduler_begin_min).state;
                        int endTotalMinutes =
                          id(${scheduler_unique_id}_scheduler_end_hour).state * 60 +
                          id(${scheduler_unique_id}_scheduler_end_min).state;
                        int checkTotalMinutes =
                          id(${scheduler_unique_id}_sntp).now().hour * 60 +
                          id(${scheduler_unique_id}_sntp).now().minute;

                        if (beginTotalMinutes <= endTotalMinutes) {
                          return checkTotalMinutes >= beginTotalMinutes &&
                                 checkTotalMinutes < endTotalMinutes;
                        } else {
                          return checkTotalMinutes >= beginTotalMinutes ||
                                 checkTotalMinutes < endTotalMinutes;
                        }
                    then:
                      - switch.turn_off: activate
                      - number.set:
                          id: router_level
                          value: !lambda return id(${scheduler_unique_id}_scheduler_router_level).state;
                      - script.execute: ${custom_script}
                    else:
                      - if:
                          condition:
                            and:
                              - switch.is_off: activate
                              - lambda: |-
                                  if (
                                    id(${scheduler_unique_id}_scheduler_end_hour).state ==
                                      id(${scheduler_unique_id}_sntp).now().hour &&
                                    id(${scheduler_unique_id}_scheduler_end_min).state ==
                                      id(${scheduler_unique_id}_sntp).now().minute
                                  ) {
                                    return true;
                                  }

                                  int beginTotalMinutes =
                                    id(${scheduler_unique_id}_scheduler_end_hour).state * 60 +
                                    id(${scheduler_unique_id}_scheduler_end_min).state;
                                  int endTotalMinutes =
                                    beginTotalMinutes +
                                    id(${scheduler_unique_id}_scheduler_checking_end_threshold).state;
                                  int checkTotalMinutes =
                                    id(${scheduler_unique_id}_sntp).now().hour * 60 +
                                    id(${scheduler_unique_id}_sntp).now().minute;

                                  if (beginTotalMinutes <= endTotalMinutes) {
                                    return checkTotalMinutes >= beginTotalMinutes &&
                                           checkTotalMinutes <= endTotalMinutes;
                                  } else {
                                    return checkTotalMinutes >= beginTotalMinutes ||
                                           checkTotalMinutes <= endTotalMinutes;
                                  }
                          then:
                            - number.set:
                                id: router_level
                                value: 0
                            - switch.turn_on: activate
